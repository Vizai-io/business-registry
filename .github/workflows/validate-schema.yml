name: Validate Business Profiles

on:
  pull_request:
    paths:
      - 'data/**/*.json'
      - 'schema/**/*.json'
  push:
    branches:
      - main
    paths:
      - 'data/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema

    - name: Find all business profile JSON files
      id: find-profiles
      run: |
        echo "Finding business profiles..."
        find data -name "*.json" -type f -not -name "index.json"

    - name: Validate all profiles
      run: |
        echo "Validating business profiles against schema..."
        EXIT_CODE=0

        for file in $(find data -name "*.json" -type f -not -name "index.json"); do
          echo "Validating: $file"
          if python tools/validation/validate-profile.py "$file"; then
            echo "[VALID] $file"
          else
            echo "[INVALID] $file"
            EXIT_CODE=1
          fi
        done

        if [ $EXIT_CODE -eq 0 ]; then
          echo "All business profiles are valid!"
        fi

        exit $EXIT_CODE

    - name: Validation Results
      if: success()
      run: echo "All business profiles are valid! âœ…"
